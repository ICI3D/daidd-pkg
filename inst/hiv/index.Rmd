---
title: "HIV in Harare tutorial"
subtitle: "International Clinics on Infectious Disease Dynamics and Data Program"
author: "Based on the spreadsheet tutorial by BG Williams and JW Hargrove<br><br>Juliet R.C. Pulliam, 2016<br>Some rights reserved<br><br><a href='http://creativecommons.org/licenses/by-nc/4.0/'>CC BY-NC 4.0</a>"
output:
  html_document:
    theme: spacelab
    code_folding: hide
runtime: shiny
---

```{r, echo=FALSE, message=FALSE}
require(deSolve)
sim.start.year <- 1975
sim.end.year <- 2025
```
<br>

## Overview {.tabset}

<div class="container-fluid" align="left">
<div class="row">
<div class="col-lg-8" padding="10px">

In this tutorial, we will fit a series of models with different model structures to HIV prevalence data from antenatal clinics (ANC data). **You should first complete the tutorial using the Harare data. If you have time, you can then move on to repeat the exercise with one of the other datasets.** In this tutorial, we'll fit the data _by eye_, which is not a very rigorous approach but is a good way to develop and intution for the model-fitting process. 
</div>

<div class="col-lg-4">
<div style="width:218px">
```{r, echo=FALSE, message=FALSE}
inputPanel(
  selectInput("useSite", label = "Dataset for fitting:",
              choices = c('Harare','South Africa','Uganda'), selected = 'Harare', width = '200px')
)
```
</div>
</div>
</div>
</div>

### Model 1

<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r,eval=FALSE}
par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
plot(year,prevalence
     , pch = 16
     , cex = 1.8
     , col = 'green'
     , ylim = c(0,1)
     , xlim = c(sim.start.year,sim.end.year)
     , bty = 'L'
     , xlab = 'Year', ylab = 'Prevalence'
     , main = paste('HIV prevalence in',input$useSite)
)
points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
```
</div>
<div class="col-lg-5">
```{r}
model1 <- function(t,y,parms){
  with(c(as.list(y),parms),{
    N <- sum(y)
    FOI <- lambda*I/N
    
    dSdt <- b*N - FOI*S - mu*S
    dIdt <- FOI*S - delta*I - mu*I
    
    list(c(dSdt,dIdt))
  })
}
```
</div>
</div>
<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r, echo=FALSE, message=FALSE}
renderPlot({
  attach('./HIVtutorial.Rdata')
  with(.selectSite(input$useSite),{
    if(input$runButton1==0){
      par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,1)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'L'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
    }else{
      require(deSolve)
      
      inits <- c(S=1,I=exp(input$p0))
      traj <- data.frame(lsoda(y = inits
                               , times = seq(1976,sim.end.year,0.1)
                               , func = model1
                               , parms = c(b = input$birthRate
                                           , mu = input$mu
                                           , lambda = input$lambda
                                           , delta = input$delta
                               )
      ))
      par(mar=c(6,5,4,4),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=4)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,1)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'u'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
      lines(traj$time,traj$I/(traj$I+traj$S),col='darkgreen')
      axis(4,seq(0,1,.2),c('0','0.2','0.4','0.6','0.8','1.0'))
      mtext('Annual per capita incidence & mortality',4,line=2.5,cex=1.5)
      lines(traj$time,input$lambda*traj$I*traj$S/(traj$I+traj$S),col='darkred')
      lines(traj$time,input$delta*traj$I/(traj$I+traj$S),col='darkblue')
      legend('topleft',c('Prevalence','Incidence','Mortality'),pch=NULL,lty=NULL,bty='n',cex=2,text.col=c('darkgreen','darkred','darkblue'))
    }
  })
},width=580)
```
</div>
<div class="col-lg-5">
```{r, echo=FALSE}
img(src = "Diagram1.png", width = '80%', align='center')
```
</div>
</div>

<div class="row" vertical-align="top">
<div class="col-lg-7">

#### Instructions

The basic model structure is shown in the diagram to the right above. You can view/hide the code used to produce the plot or specify the model by toggling the associated **Code** button.

1. Investigate the model structure.
- Make sure you understand what each of the parameters means.
- Where in the model code does it show that the instantaneous rate of change of the susceptible compartment is calculated as the total birth rate, minus the _per capita_ background death rate, minus incidence? How would you express this as a differential equation?
- How is the incidence of infection calculated, and how would you write this as a mathematical expression?
- Where in the code does it show that the instantaneous rate of change of the infectious compartment is calculated as incidence of infection, minus the background mortality rate, minus the total rate at which infected individuals die of AIDS?
- How is the total mortality rate for infectious individuals calculated, and how would you write this as a mathematical expression?
2. Run the model and compare the model predictions to ANC data.
- In the plot to the left, the estimated HIV infection prevalence (based on ANC data) is shown as green points.
- The model prediction for the trajectory of HIV prevalence is shown in dark green.
- Visually compare the model prediction to the available data. Does the model do a good job of predicting the data?
- The model prediction based on the default parameter values and initial conditions is very bad.
- Try adjusting the parameter values by setting $\lambda$ to 0.4 and 0.6 and by setting the natural log of initial prevalence to be -6 and -9.
- No matter what values we use for the model parameters, the model prediction does not look like the data: the prevalence is always much too high and the population crashes.
- Continue to adjust the parameters and initial conditions until you're convinced the model will not fit the data. 

_You can now move on to Model 2._
</div>
<div class="col-lg-5" align="left">

#### Parameters and initial conditions
```{r, echo=FALSE}
sidebarPanel(
  actionButton("runButton1","Show model output (see plot above)",width = "100%"),
  br(),
  br(),
  sliderInput('lambda',
              div(HTML('Rate at which new infections occur (&lambda;):')),
              min = 0,
              max = 0.6,
              value = 0.5,
              step = 0.05),
  sliderInput('p0',
              'Natural log of the intial infection prevalence:',
              min = -10,
              max = -3,
              value = -7,
              step = 0.5),
  sliderInput('birthRate',
              div(HTML('Per capita birth rate (b):')),
              min = 0.01,
              max = 0.04,
              value = 0.029,
              step = 0.001),
  sliderInput('delta',
              div(HTML('Per capita disease-induced mortality rate (&delta;):')),
              min = 0,
              max = 0.5,
              value = 0.1,
              step = 0.05),
  sliderInput('mu',
              div(HTML('Per capita background mortality rate (&mu;):')),
              min = 0.01,
              max = 0.04,
              value = 0.018,
              step = 0.001),
  width = 10
)
```
</div>
</div>

### Model 2


<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r,eval=FALSE}
par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
plot(year,prevalence
     , pch = 16
     , cex = 1.8
     , col = 'green'
     , ylim = c(0,0.4)
     , xlim = c(sim.start.year,sim.end.year)
     , bty = 'L'
     , xlab = 'Year', ylab = 'Prevalence'
     , main = paste('HIV prevalence in',input$useSite)
)
points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
```
</div>
<div class="col-lg-5">
```{r}
model2 <- function(t,y,parms){
  with(c(as.list(y),parms),{
    N <- sum(y)
    lambdaHat <- lambda*exp(-a*I/N)
    FOI <- lambdaHat*I/N
    
    dSdt <- b*N - FOI*S - mu*S
    dIdt <- FOI*S - delta*I - mu*I
    
    list(c(dSdt,dIdt))
  })
}
```
</div>
</div>
<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r, echo=FALSE, message=FALSE}
renderPlot({
  attach('./HIVtutorial.Rdata')
  with(.selectSite(input$useSite),{
    if(input$runButton2==0){
      par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,0.4)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'L'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
    }else{
      require(deSolve)
      
      inits <- c(S=1,I=exp(-7))
      traj <- data.frame(lsoda(y = inits
                               , times = seq(1976,sim.end.year,0.1)
                               , func = model2
                               , parms = c(b = input$birthRate2
                                           , a = input$a
                                           , mu = 0.018
                                           , lambda = input$lambda2
                                           , delta = 0.1
                               )
      ))
      par(mar=c(6,5,4,4),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=4)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,0.4)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'u'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      inc <- input$lambda2*traj$I*traj$S/(traj$I+traj$S)*exp(-input$a*traj$I/(traj$I+traj$S))
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
      lines(traj$time,traj$I/(traj$I+traj$S),col='darkgreen')
      axis(4,seq(0,0.03,.005)*.4/.03,seq(0,0.03,.005))
      mtext('Annual per capita incidence & mortality',4,line=2.5,cex=1.5)
      lines(traj$time,inc*.4/.03,col='darkred')
      lines(traj$time,0.1*traj$I/(traj$I+traj$S)*.4/.03,col='darkblue')
      legend('topleft',c('Prevalence','Incidence','Mortality'),pch=NULL,lty=NULL,bty='n',cex=2,text.col=c('darkgreen','darkred','darkblue'))
    }
  })
},width=580)
```
</div>
<div class="col-lg-5">
```{r, echo=FALSE}
img(src = "Diagram2.png", width = '80%', align='center')
```
</div>
</div>

<div class="row" vertical-align="top">
<div class="col-lg-7">

#### Instructions

For Model 1, we found that the prevalence always remained much too high relative to the decline observed in the data. Since some people are likely to have lots of sex, and get infected quickly, while others are likely to have no sex, and never get infected, we may want to modify the model to reflect this heterogeniety in infection risk. There are many ways we could do this, but one of the simplest options -- as described in Jonathan's heterogeneity lecture -- is to define the transmission coefficient as a function of infection prevalence; here, we use the functional form $\hat{\lambda} = \lambda e^{-aP}$, where $a$ is a parameter that determines how rapidly transmisison declines as a function of prevalence and $P = \frac{I}{N}$ is the prevalence of infection.

3. Investigate the new model structure.
- Make sure you understand what each of the parameters means.
- Where in the model code is the hetergeneity represented?
4. Run the model and compare the model predictions to ANC data.
- Visually compare the model prediction to the available data. Does the model do a good job of predicting the data?
- Try adjusting the value of $a$ to see if you can improve the fit.
- We can never get the prevalence curve to peak and then come down.
- Nevertheless, if we set $a$ to about 8, we can bring the prevalence down to about the right level. Do this, and then change the values of $\lambda$ and $b$ to see how well you can fit the initial rise of infection.

Looking at the graph, we see that the mortality precisely follows the trend in prevalence while we know that there should be a delay between the rise in prevalence and the rise in mortality. The reason the mortality curve tracks the prevalence curve is that we have assumed a constant _per capita_ death rate for infected individuals, whereas we know that probability of dying after HIV infection increases with the time since infection. Next, we will modify the model to account for this delay in mortality.

_You can now move on to Model 3._

</div>
<div class="col-lg-5" align="left">

#### Parameters and initial conditions
```{r, echo=FALSE}
sidebarPanel(
  actionButton("runButton2","Show model output (see plot above)",width = "100%"),
  br(),
  br(),
  sliderInput('a',
              'Rate of decline as a function of prevalence (a):',
              min = 0,
              max = 20,
              value = 0,
              step = 0.5),
  sliderInput('lambda2',
              div(HTML('Rate at which new infections occur (&lambda;):')),
              min = 0,
              max = 0.6,
              value = 0.5,
              step = 0.05),
  sliderInput('birthRate2',
              div(HTML('Per capita birth rate (b):')),
              min = 0.01,
              max = 0.04,
              value = 0.029,
              step = 0.001),
  width = 10
)
```
</div>
</div>



### Model 3

<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r,eval=FALSE}
par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
plot(year,prevalence
     , pch = 16
     , cex = 1.8
     , col = 'green'
     , ylim = c(0,0.4)
     , xlim = c(sim.start.year,sim.end.year)
     , bty = 'L'
     , xlab = 'Year', ylab = 'Prevalence'
     , main = paste('HIV prevalence in',input$useSite)
)
points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
```
</div>
<div class="col-lg-5">
```{r}
model3 <- function(t,y,parms){
  with(c(as.list(y),parms),{
    N <- sum(y)
    I <- I1 + I2 + I3 + I4
    
    lambdaHat <- lambda*exp(-a*I/N)
    FOI <- lambdaHat*I/N
    
    g <- 4*delta
    
    dSdt <- b*N - FOI*S - mu*S
    dI1dt <- FOI*S - g*I1 - mu*I1
    dI2dt <- g*I1 - g*I2 - mu*I2
    dI3dt <- g*I2 - g*I3 - mu*I3
    dI4dt <- g*I3 - g*I4 - mu*I4
    
    list(c(dSdt,dI1dt,dI2dt,dI3dt,dI4dt))
  })
}
```
</div>
</div>

<div class="row" vertical-align="bottom">
<div class="col-lg-7">
```{r, echo=FALSE, message=FALSE}
renderPlot({
  attach('./HIVtutorial.Rdata')
  with(.selectSite(input$useSite),{
    if(input$runButton3==0){
      par(mar=c(6,5,4,0),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=3)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,0.4)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'L'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
    }else{
      require(deSolve)
      
      inits <- c(S=1,I1=exp(-7),I2=0,I3=0,I4=0)
      traj <- data.frame(lsoda(y = inits
                               , times = seq(1976,sim.end.year,0.1)
                               , func = model3
                               , parms = c(b = 0.029
                                           , a = input$a3
                                           , mu = 0.018
                                           , lambda = input$lambda3
                                           , delta = 0.1
                               )
      ))
      traj$I <- traj$I1+traj$I2+traj$I3+traj$I4
      inc <- input$lambda3*traj$I*traj$S/(traj$I+traj$S)*exp(-input$a3*traj$I/(traj$I+traj$S))
      par(mar=c(6,5,4,4),cex.axis=1.5,cex.lab=1.5,cex.main=1.5,lwd=4)
      plot(year,prevalence
           , pch = 16
           , cex = 1.8
           , col = 'green'
           , ylim = c(0,0.4)
           , xlim = c(sim.start.year,sim.end.year)
           , bty = 'u'
           , xlab = 'Year', ylab = 'Prevalence'
           , main = paste('HIV prevalence in',input$useSite)
      )
      points(year,prevalence,cex=1.8,lwd=2,col='darkgreen')
      lines(traj$time,traj$I/(traj$I+traj$S),col='darkgreen')
      axis(4,seq(0,0.025,.005)*.4/.025,seq(0,0.025,.005))
      mtext('Annual per capita incidence & mortality',4,line=2.5,cex=1.5)
      lines(traj$time,inc*.4/.025,col='darkred')
      lines(traj$time,0.1*4*traj$I4/(traj$I+traj$S)*.4/.025,col='darkblue')
      legend('topleft',c('Prevalence','Incidence','Mortality'),pch=NULL,lty=NULL,bty='n',cex=2,text.col=c('darkgreen','darkred','darkblue'))
    }
  })
},width=580)
```
</div>
<div class="col-lg-5">
```{r, echo=FALSE}
img(src = "Diagram3.png", width = '80%', align='center')
```
</div>
</div>

<div class="row" vertical-align="top">
<div class="col-lg-7">

#### Instructions

The easiest way to delay mortality in the model is to modify the way we represent the course of infection. Instead of having a single infected compartment, we can introduce additional compartments that infected individuals must flow through before they can die of AIDS. This changes the survival curve to look much more like the observed survival curve (see the inset on the model diagram figure).

5. Investigate the new model structure.
- Make sure you understand what each of the parameters means. Why do we set $g=4\delta$?
- What is the effect of this delay on the timing of the rise in mortality reltaive to the timing of the rise in prevalence?
6. Run the model and compare the model predictions to ANC data.
- Visually compare the model prediction to the available data. Does the model do a good job of predicting the data?
- Try changing the values of $a$ and $\lambda$ to see how well you can fit the initial rise of infection.

We still cannot fit the decline in prevalence but at least we know that AIDS deaths are not sufficient to bring about the decline. What other real-world processes might need to be added to the model world in order to explain the observed decline in prevalence?

</div>
<div class="col-lg-5" align="left">

#### Parameters and initial conditions
```{r, echo=FALSE}
sidebarPanel(
  actionButton("runButton3","Show model output (see plot above)",width = "100%"),
  br(),
  br(),
  sliderInput('a3',
              div(HTML('Rate of decline as a function of prevalence (a):')),
              min = 0,
              max = 20,
              value = 8,
              step = 0.5),
  sliderInput('lambda3',
              div(HTML('Rate at which new infections occur (&lambda;):')),
              min = 0,
              max = 0.6,
              value = 0.5,
              step = 0.05),
  width = 10
)
```
</div>
</div>

<br>

```{r, echo = FALSE}
detach()
```
